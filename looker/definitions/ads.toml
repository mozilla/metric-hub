[metrics]

[metrics.billed_revenue]
select_expression = "SUM(billed_revenue)"
data_source = "admarketplace"
description = "Revenue reported by Admarketplace. Will almost always have a few days of lag"

[metrics.spoc_impressions]
select_expression = "SUM(impressions)"
data_source = "consolidated_ads_spocs"
friendly_name = "SPOC impressions"
description = "Daily SPOC impressions"

[metrics.spoc_clicks]
select_expression = "SUM(clicks)"
data_source = "consolidated_ads_spocs"
friendly_name = "SPOC clicks"
description = "Daily SPOC clicks"

[metrics.spoc_revenue]
select_expression = "SUM(revenue)"
data_source = "consolidated_ads_spocs"
friendly_name = "SPOC revenue"
description = "Daily SPOC revenue"

[metrics.billed_revenue.statistics.sum]
[metrics.spoc_impressions.statistics.sum]
[metrics.spoc_clicks.statistics.sum]
[metrics.spoc_revenue.statistics.sum]

[metrics.native_spend]
select_expression = "SUM(spend)"
data_source = "native_desktop_ad_metrics"
friendly_name = "Native Spend"
description ="Native Desktop Metrics spend"

[metrics.native_dismisses]
select_expression = "SUM(dismisses)"
data_source = "native_desktop_ad_metrics"
friendly_name = "Native Dismisses"
description ="Native Desktop Metrics dismisses"

[metrics.native_impressions]
select_expression = "SUM(impressions)"
data_source = "native_desktop_ad_metrics"
friendly_name = "Native Impressions"
description ="Native Desktop Metrics impressions"

[metrics.native_clicks]
select_expression = "SUM(clicks)"
data_source = "native_desktop_ad_metrics"
friendly_name = "Native Clicks"
description ="Native Desktop Metrics clicks"

[metrics.native_saves]
select_expression = "SUM(saves)"
data_source = "native_desktop_ad_metrics"
friendly_name = "Native Saves"
description ="Native Desktop Metrics saves"

[metrics.native_spend.statistics.sum]
[metrics.native_dismisses.statistics.sum]
[metrics.native_impressions.statistics.sum]
[metrics.native_clicks.statistics.sum]
[metrics.native_saves.statistics.sum]
[metrics.native_dismisses.statistics.ratio]
numerator = "native_dismisses.sum"
denominator = "native_impressions.sum"
[metrics.native_clicks.statistics.ratio]
numerator = "native_clicks.sum"
denominator = "native_impressions.sum"
[metrics.native_saves.statistics.ratio]
numerator = "native_saves.sum"
denominator = "native_impressions.sum"

[data_sources]

[data_sources.admarketplace]
from_expression = "mozdata.revenue.admarketplace"
client_id_column = "NULL"
friendly_name = "Admarketplace"
description = "Revenue numbers reported by AMP"
columns_as_dimensions = true
submission_date_column = "adm_date"

[data_sources.consolidated_ads_spocs]
from_expression = """
(
  SELECT
    DATE(submission_timestamp) AS submission_date,
    advertiser as client,
    campaign_name,
    targeted_country,
    rate_type,
    creative_title as title,
    creative_url as url,
    image_url as image,
    SUM(impressions) AS impressions,
    SUM(clicks) AS clicks,
    SUM(revenue) AS revenue
  FROM `mozdata.ads.consolidated_ad_metrics_hourly`
  GROUP BY
    submission_date,
    advertiser,
    campaign_name,
    targeted_country,
    rate_type,
    creative_title,
    creative_url,
    image_url
)
"""
friendly_name = "Default Looker Base Fields for Firefox SPOC Reporting"
description = """
  Default fields used to filter and segment metric definition views in Looker
  for Firefox SPOC reporting
"""
columns_as_dimensions = true
submission_date_column = "submission_date"
client_id_column = "NULL"

[data_sources.native_desktop_ad_metrics]
from_expression = "moz-fx-data-shared-prod.ads.native_desktop_ad_metrics_hourly"
friendly_name = "Native Desktop Ads Metrics Daily"
description = """
  Tracks Native Desktop Ad Metrics Across Days
"""
columns_as_dimensions = false
submission_date_column = "submission_date"
client_id_column = "NULL"

[data_sources.native_desktop_ad_metrics_v1]
from_expression = """
(
  SELECT
    submission_date,
    spoc_id,
    position,
    advertiser,
    campaign_name,
    title,
    flight_id,
    creative_type,
    site_name,
    zone_name,
    country,
    rate_type,
    pid,
    ad_url,
    image_url,
    external_param,
    campaign_id
  FROM `moz-fx-data-shared-prod.ads.native_desktop_ad_metrics_hourly`
)
"""
friendly_name = "Native Desktop Ads Metrics Daily"
description = """
  Tracks Native Desktop Ad Metrics Across Days
"""
columns_as_dimensions = true
submission_date_column = "submission_date"
client_id_column = "NULL"

# The purpose of the below join is to hide metrics from surfacing in Looker as dimensions.
[data_sources.native_desktop_ad_metrics.joins.native_desktop_ad_metrics_v1]
relationship = "one_to_one"
on_expression = """
  native_desktop_ad_metrics.submission_date = native_desktop_ad_metrics_v1.submission_date
  AND native_desktop_ad_metrics.spoc_id = native_desktop_ad_metrics_v1.spoc_id
  AND native_desktop_ad_metrics.position = native_desktop_ad_metrics_v1.position
  AND native_desktop_ad_metrics.advertiser = native_desktop_ad_metrics_v1.advertiser
  AND native_desktop_ad_metrics.title = native_desktop_ad_metrics_v1.title
  AND native_desktop_ad_metrics.flight_id = native_desktop_ad_metrics_v1.flight_id
  AND native_desktop_ad_metrics.creative_type = native_desktop_ad_metrics_v1.creative_type
  AND native_desktop_ad_metrics.country = native_desktop_ad_metrics_v1.country
  AND native_desktop_ad_metrics.rate_type = native_desktop_ad_metrics_v1.rate_type
  AND native_desktop_ad_metrics.pid = native_desktop_ad_metrics_v1.pid
  AND native_desktop_ad_metrics.ad_url = native_desktop_ad_metrics_v1.ad_url
  AND native_desktop_ad_metrics.campaign_id = native_desktop_ad_metrics_v1.campaign_id
 """
