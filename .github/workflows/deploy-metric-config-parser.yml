name: "Deploy metric-config-parser"

on:
  push:
    branches:
      - main
    paths:
      - 'lib/metric-config-parser/*.yaml'

jobs:
  changed:
    uses: ./.github/workflows/changed-files.yml
    with:
      path_filter: |
        lib/metric-config-parser/*.yaml

  deploy-metric-config-parser:
    runs-on: ubuntu-latest
    container:
      image: python:3.10
    needs: changed
    if: needs.changed.outputs.any_changed == 'true'
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        path: ~/project
    - name: Check for package version change in last commit before proceeding.
      working-directory: ~/project/lib/metric-config-parser
      run: |
        if git diff main HEAD~1 pyproject.toml | grep 'version'
          then
            echo "Found changes to package version dir, proceeding with deployment."
          else
            echo "No changes in package version. Skipping metric-config-parser deployment."
            circleci-agent step halt
        fi
    - name: Install deployment tools
      working-directory: ~/project/lib/metric-config-parser
      run: |
        pip install --upgrade build setuptools wheel twine
    - name: Create the distribution files
      working-directory: ~/project/lib/metric-config-parser
      run: |
        python3.10 -m build --sdist
    - name: Upload to PyPI
      working-directory: ~/project/lib/metric-config-parser
      run: |
        # Relies on the TWINE_USERNAME and TWINE_PASSWORD environment variables configured at:
        #   https://circleci.com/gh/mozilla/metric-config-parser/edit#env-vars
        # For more on twine, see:
        #   https://twine.readthedocs.io/en/latest/
        twine upload --skip-existing dist/*
