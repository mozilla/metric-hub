name: "Deploy metric-config-parser"

# on:
#   push:
#     branches:
#       - main
#     paths:
#       - 'lib/metric-config-parser/pyproject.yaml'

jobs:
  changed:
    uses: ./.github/workflows/changed-files.yml
    with:
      path_filter: |
        lib/metric-config-parser/pyproject.yaml

  deploy-metric-config-parser:
    container:
      image: python:3.10
    working_directory: ~/project/lib/metric-config-parser
    needs: changed
    if: needs.changed.outputs.any_changed == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: ~/project
      - name: Check for package version change in last commit before proceeding.
        run: |
          if git diff main HEAD~1 pyproject.toml | grep 'version'
            then
              echo "Found changes to package version dir, proceeding with deployment."
            else
              echo "No changes in package version. Skipping metric-config-parser deployment."
              circleci-agent step halt
          fi
      - name: Install deployment tools
        run: |
          pip install --upgrade build setuptools wheel twine
      - name: Create the distribution files
        run: |
          python3.10 -m build --sdist
      - name: Upload to PyPI
        run: |
          # Relies on the TWINE_USERNAME and TWINE_PASSWORD environment variables configured at:
          #   https://circleci.com/gh/mozilla/metric-config-parser/edit#env-vars
          # For more on twine, see:
          #   https://twine.readthedocs.io/en/latest/
          twine upload --skip-existing dist/*
