# Reusable workflow to checkout code, setup python, and authenticate
name: Checkout and Authenticate

on:
  workflow_call:
    inputs:
      token_audience:
        type: string
        description: 'ID Token Audience'
        required: false
        default: 'https://us-central1-moz-fx-data-shared-prod.cloudfunctions.net/bigquery-etl-dryrun'
    outputs:
      id_token:
        description: 'ID Token'
        value: ${{ jobs.checkout-and-auth.outputs.id_token }}

jobs:
  checkout-and-auth:
    name: Checkout and Authenticate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}
    - name: Setup python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip'
    - name: Authenticate to GCP
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ vars.GCPV2_GITHUB_WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ secrets.GCP_INTEGRATION_SERVICE_ACCOUNT_EMAIL }}
        token_format: id_token
        id_token_audience: ${{ inputs.token_audience }}
        id_token_include_email: true
    - name: Export ID Token for Python
      run: echo "GOOGLE_GHA_ID_TOKEN=${{ steps.auth.outputs.id_token }}" >> $GITHUB_ENV
